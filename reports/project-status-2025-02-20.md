# Mandatory workflow: Binary asset handling

The `make_pr` tool cannot accept binary payloads, so every slice must keep the repository text-only while still providing deterministic media fixtures locally. Follow this workflow without exception:

- **Check in source-of-truth generators, not binaries.** For each required asset (e.g., MP3/WAV/FLAC samples, cover art, QR exports) add a small script or fixture module that emits the file from base64/PCM literals during `pnpm prepare` or a dedicated `pnpm generate:fixtures` step. Keep the generated outputs in a git-ignored `fixtures/` folder so `make_pr` never sees binary blobs.
- **Wire generators into tests and build tooling.** Update the relevant Vitest/Playwright setup (and any PWA cache seeding hooks) to call the generator before suites run, ensuring offline/install/update tests still exercise the real payloads they expect.
- **Document the workflow.** Add developer-doc notes that contributors must run the generator (or rely on an automated pre-test hook) after checkout, so everyone has the binaries locally even though they’re absent from commits.

# Project Status — 2025-02-20

## Executive Summary — February 20 Update
- Registered Nest's throttler module with a 60-second/100-request global window, layered 5-per-minute rate limits onto signup, login, refresh, and logout, and extended the auth e2e suite to assert `429` payloads while keeping the in-memory storage resettable for tests.【F:apps/api/src/app.module.ts†L1-L37】【F:apps/api/src/auth/auth.controller.ts†L1-L33】【F:apps/api/test/auth-roles.e2e.spec.ts†L1-L146】【F:packages/nestjs-throttler/index.js†L1-L161】
- Introduced a shared `@shellff/config` workspace package so apps pull consistent ESLint and TypeScript settings, and broadened the root `.gitignore` to keep transient artifacts like `cookies.txt` out of version control.【F:packages/config/package.json†L1-L12】【F:.gitignore†L1-L47】【F:.gitignore†L63-L66】
- Rebuilt the API data layer with release, unlock, wallet, and download domain models, delivered the associated SQL migration, and seeded representative data spanning demo releases, codes, wallets, and download bundles for end-to-end testing.【F:apps/api/prisma/migrations/20250220020000_add_unlock_wallet_download/migration.sql†L1-L153】【F:apps/api/prisma/migrations/20250220020000_add_unlock_wallet_download/migration.sql†L154-L208】【F:apps/api/prisma/seed.ts†L220-L334】【F:apps/api/prisma/seed.ts†L335-L452】
- Landed first-class password reset tokens, device fingerprints, and session lifecycle tables in Prisma alongside matching indexes and triggers so auth flows can track per-device refreshes and recovery events moving forward.【F:apps/api/prisma/schema.prisma†L98-L299】【F:apps/api/prisma/migrations/20250220030000_add_password_reset_and_sessions/migration.sql†L1-L93】
- Extended device tracking by persisting nullable `userAgent` strings on `UserDevice`, indexing the `userId`/`userAgent` lookup, and regenerating the Prisma client so session metadata can associate repeat browsers without extra fingerprints.【F:apps/api/prisma/schema.prisma†L250-L271】【F:apps/api/prisma/migrations/20250220030000_add_password_reset_and_sessions/migration.sql†L36-L64】
- Exposed the new `publicId` across the in-memory Prisma harness and web schema while updating the unlock album page to route unauthenticated listeners through the canonical `/auth/login` flow.【F:apps/api/test/utils/in-memory-prisma.service.ts†L8-L123】【F:apps/api/test/utils/in-memory-prisma.service.ts†L171-L202】【F:apps/web/prisma/schema.prisma†L1-L28】【F:apps/web/app/unlock-album/page.tsx†L1-L88】
- Swapped the profile UI over to the `/api/profile` client fetcher, wired account settings edits and avatar actions through the REST endpoints, and added Vitest coverage that exercises success and error flows against mocked responses.【F:apps/web/components/profile/ProfileContent.tsx†L4-L260】【F:apps/web/app/settings/account/page.tsx†L4-L260】【F:apps/web/lib/profile-client.ts†L1-L138】【F:apps/web/lib/__tests__/profile-client.test.ts†L1-L152】
- Introduced catalog and download feature modules in the Nest API with Prisma-backed release listings, search, and bundle preparation, instrumented audit/analytics hooks for queries and lifecycle transitions, and refactored the web offline cache to request bundles via the new API while emitting download analytics with dedicated tests.【F:apps/api/src/catalog/catalog.module.ts†L1-L13】【F:apps/api/src/catalog/catalog.service.ts†L1-L168】【F:apps/api/src/downloads/downloads.service.ts†L1-L210】【F:apps/web/lib/offline-cache.ts†L1-L237】【F:apps/web/lib/__tests__/offline-cache.test.ts†L1-L87】
- Expanded telemetry coverage with `/api/version` and `/api/status` endpoints, associated service helpers, updated README docs, and Vitest specs plus a new PWA test harness that verifies install prompts, offline fallback rendering, and service worker refresh flows.【F:apps/api/src/telemetry/telemetry.controller.ts†L1-L35】【F:apps/api/src/telemetry/telemetry.service.ts†L1-L60】【F:apps/api/src/telemetry/telemetry.service.spec.ts†L1-L60】【F:apps/api/README.md†L16-L21】【F:apps/web/vitest.config.pwa.ts†L1-L23】【F:apps/web/pwa-tests/pwa.spec.tsx†L1-L260】

## 1. Completed Work to Date
### Monorepo, Tooling, and Quality Gates
- Rebuilt the workspace around pnpm and Turbo so lint, typecheck, test, and build steps fan out across every package via shared scripts and pipeline definitions, establishing the slice roadmap’s required tooling baseline.【F:package.json†L1-L28】【F:pnpm-workspace.yaml†L1-L4】【F:turbo.json†L1-L1】
- Centralised linting through a flat ESLint 9 configuration that unifies browser, Node, and Vitest globals with package-aware overrides, keeping React, Next.js, API, and script code under a single ruleset.【F:eslint.config.mjs†L4-L256】
- Hardened CI to provision Postgres, wait for readiness, run Prisma migrations, and only then execute lint/type/test so schema drift is caught automatically in pull requests.【F:.github/workflows/ci.yml†L18-L78】
### Backend & Data Foundations
- Authored Slice 0’s Prisma schema, baseline migration, and expanded seed script to cover users, creator profiles, role assignments, audit logs, feature flags, and creator code generation aligned with the vertical plan’s role model.【F:apps/api/prisma/schema.prisma†L1-L128】【F:apps/api/prisma/migrations/20250220000000_slice0_init/migration.sql†L1-L112】【F:apps/api/prisma/seed.ts†L13-L197】
- Extended the schema again to introduce password reset, session, and device metadata models plus a session-aware refresh token link, backed by a dedicated migration so downstream auth tasks can build on persistent recovery and device context.【F:apps/api/prisma/schema.prisma†L105-L299】【F:apps/api/prisma/migrations/20250220030000_add_password_reset_and_sessions/migration.sql†L1-L93】
- Authored Slice 0’s Prisma schema, baseline migration, and expanded seed script to cover users, creator profiles, role assignments, audit logs, feature flags, and creator code generation aligned with the vertical plan’s role model.【F:apps/api/prisma/schema.prisma†L1-L120】【F:apps/api/prisma/migrations/20250220000000_slice0_init/migration.sql†L1-L112】【F:apps/api/prisma/seed.ts†L13-L197】
- Bootstrapped NestJS with environment validation, global Prisma access, a shared audit service, and feature modules for auth, roles, feature flags, audit, and telemetry that expose DTO-backed controllers while enforcing a global validation pipe and `/api` prefix.【F:apps/api/src/app.module.ts†L1-L27】【F:apps/api/src/config/env.validation.ts†L1-L75】【F:apps/api/src/audit/audit.controller.ts†L1-L23】【F:apps/api/src/auth/auth.controller.ts†L1-L20】【F:apps/api/src/roles/roles.controller.ts†L1-L20】【F:apps/api/src/feature-flags/feature-flags.controller.ts†L1-L26】【F:apps/api/src/telemetry/telemetry.controller.ts†L1-L23】【F:apps/api/src/main.ts†L7-L20】
- Implemented service logic and unit specs that hash passwords, persist audit logs, manage role upgrades, evaluate feature flags with overrides, and expose telemetry health/metrics endpoints backed by Prisma mocks for regression coverage.【F:apps/api/src/auth/auth.service.ts†L19-L133】【F:apps/api/src/audit/audit.service.ts†L6-L55】【F:apps/api/src/roles/roles.service.ts†L21-L169】【F:apps/api/src/feature-flags/feature-flags.service.ts†L21-L200】【F:apps/api/src/telemetry/telemetry.service.ts†L1-L37】【F:apps/api/src/auth/auth.service.spec.ts†L27-L99】【F:apps/api/src/roles/roles.service.spec.ts†L27-L113】【F:apps/api/src/feature-flags/feature-flags.service.spec.ts†L27-L200】【F:apps/api/src/telemetry/telemetry.service.spec.ts†L1-L47】
- Layered feature-flag caching with TTL-driven eviction and per-key fetch deduplication, invalidated on updates/overrides, and extended audit log listings with cursor pagination plus targeted unit specs to prove memoisation and cursor behaviour for the management flows.【F:apps/api/src/feature-flags/feature-flags.service.ts†L33-L185】【F:apps/api/src/feature-flags/feature-flags.service.spec.ts†L79-L166】【F:apps/api/src/audit/audit.controller.ts†L10-L35】【F:apps/api/src/audit/audit.service.ts†L32-L55】【F:apps/api/src/audit/audit.service.spec.ts†L25-L95】
- Delivered JWT-backed session issuance with hashed refresh-token persistence, refresh/logout endpoints, admin/moderator-guarded management controllers, and Vitest e2e coverage validating authenticated role flows.【F:apps/api/src/auth/auth.service.ts†L19-L226】【F:apps/api/src/auth/token.service.ts†L15-L162】【F:apps/api/src/auth/jwt-auth.guard.ts†L1-L45】【F:apps/api/src/auth/roles.guard.ts†L1-L39】【F:apps/api/src/roles/roles.controller.ts†L1-L22】【F:apps/api/src/feature-flags/feature-flags.controller.ts†L1-L30】【F:apps/api/src/audit/audit.controller.ts†L1-L25】【F:apps/api/test/auth-roles.e2e.spec.ts†L1-L280】
- Documented the Slice 0 API surface and seed expectations so downstream consumers know how to exercise the new endpoints and local fixtures.【F:apps/api/README.md†L1-L34】
### Web PWA Developer Experience
- Added local Vitest type declarations, TS config wiring, and a custom runner script so the web workspace can type-check and execute tests without relying on hoisted dependencies from other packages.【F:apps/web/types/vitest/index.d.ts†L1-L163】【F:apps/web/types/vitest/globals.d.ts†L1-L23】【F:apps/web/types/vitest/config.d.ts†L1-L43】【F:apps/web/types/vitest/importMeta.d.ts†L1-L11】【F:apps/web/tsconfig.json†L1-L24】【F:apps/web/scripts/run-vitest.mjs†L1-L50】
- Updated the web package scripts so `pnpm --filter @shellff/web test` resolves the Vitest CLI from pnpm’s virtual store, keeping local and CI executions aligned.【F:apps/web/package.json†L1-L29】【F:apps/web/scripts/run-vitest.mjs†L1-L50】
### Install, Ops, and Infrastructure Scaffolding
- Restored install tooling with a committed environment template and cross-platform bootstrap and seed scripts that set up `.env`, verify prerequisites, and run Prisma migrations/seeds for contributors.【F:install/.env.example†L1-L11】【F:install/scripts/bootstrap.sh†L1-L30】【F:install/scripts/bootstrap.ps1†L1-L38】【F:install/scripts/seed.sh†L1-L5】【F:install/scripts/seed.ps1†L1-L5】
- Reintroduced Docker Compose services for Postgres, Redis, MinIO, and Prometheus plus a matching Prometheus scrape config to support local Slice 0 development flows.【F:docker-compose.yml†L1-L51】【F:monitoring/prometheus.yml†L1-L7】
- Rebuilt Terraform modules for network, database, cache, storage, observability, and app workloads, then wired a staging environment layer with opt-in toggles for each resource group.【F:infra/terraform/modules/network/main.tf†L1-L68】【F:infra/terraform/modules/database/main.tf†L1-L43】【F:infra/terraform/modules/cache/main.tf†L1-L39】【F:infra/terraform/modules/storage/main.tf†L1-L29】【F:infra/terraform/modules/observability/main.tf†L1-L9】【F:infra/terraform/modules/app/main.tf†L1-L58】【F:infra/terraform/environments/staging/main.tf†L1-L59】【F:infra/terraform/environments/staging/variables.tf†L1-L68】
## Vertical Slice Review
### Slice 1 — Auth & Sessions
- **Shipped:** Implemented login, OTP, and registration UX within `apps/web/components/auth`, wired NextAuth session handling through `apps/web/lib/auth.ts` and the `apps/web/app/api/auth` routes, and exposed matching NestJS auth endpoints in `apps/api/src/auth` for credential issuance, refresh, and logout.
- **Gaps:**
  - Land service-layer wiring that persists device and session records through Prisma and prove it with auth refresh/logout tests showing rows created and revoked per device.
  - Publish OTP and password reset endpoints with matching web flows and acceptance specs that demonstrate token issuance, verification, and invalidation.
  - Centralise throttling and monitoring in a shared module with dashboards or logs that confirm rate-limit hits and anomaly alerts during load tests.
  - Instrument analytics events for each auth milestone and document dashboards or queries that surface OTP, reset, and session metrics.
  - Add cross-channel e2e tests (web ↔ API) that exercise login, OTP, reset, and logout journeys to confirm session continuity across devices.
### Slice 2 — Profiles & Settings
- **Shipped:** Profile and settings surfaces now hydrate through the shared `/api/profile` client, deliver error states, call the profile and avatar REST endpoints for edits, and include integration tests that lock in both successful updates and failure handling.【F:apps/web/components/profile/ProfileContent.tsx†L4-L260】【F:apps/web/app/settings/account/page.tsx†L4-L260】【F:apps/web/lib/profile-client.ts†L1-L138】【F:apps/web/lib/__tests__/profile-client.test.ts†L1-L152】
- **Gaps:** Extend the profile feature set with password change UX, ensure role switches trigger session refreshes, and add coverage for password/role flows once implemented.【F:apps/web/app/api/profile/password/route.ts†L9-L78】【F:apps/web/app/api/profile/role-switch/route.ts†L8-L99】
### Slice 3 — Catalog & Search
- **Shipped:** The web catalog now surfaces tabbed track, album, and artist discovery with search, genre/mood filters, and player hand-off through the `MusicCatalog` experience, backed by Prisma-powered search, listing, and pagination APIs for `/api/search`, `/api/tracks`, `/api/albums`, and `/api/artists`.【F:apps/web/components/music/music-catalog.tsx†L4-L200】【F:apps/web/app/api/search/route.ts†L5-L167】【F:apps/web/app/api/tracks/route.ts†L7-L163】【F:apps/web/app/api/albums/route.ts†L6-L153】【F:apps/web/app/api/artists/route.ts†L6-L106】
- **Gaps:** Production search still needs ingestion/sync pipelines, result ranking, and personalization heuristics so the catalog stays fresh across regions and surfaces relevant results beyond the current Prisma queries.【F:apps/api/src/catalog/catalog.service.ts†L41-L123】
### Slice 4 — Playback & Queue
- **Shipped:** End-to-end playback spans the shared `MusicPlayerContext`, responsive mini/full players, queue manager controls, and the offline download manager with IndexedDB caching, enabling shuffle/repeat flows, background progress sync, and saved playback for PWA use.【F:apps/web/contexts/MusicPlayerContext.tsx†L4-L200】【F:apps/web/components/player/MiniPlayer.tsx†L1-L200】【F:apps/web/components/player/QueueManager.tsx†L1-L200】【F:apps/web/components/player/OfflineDownloadManager.tsx†L3-L200】【F:apps/web/lib/offline-cache.ts†L1-L200】
- **Gaps:** We still owe streaming token issuance, server-driven queue APIs, resilience tests, and deeper service-worker integration so offline playback, rights enforcement, and background control parity hold up under real traffic.
### Slice 5 — Library
- **Shipped:** Listeners manage likes, playlists, history, and recommendations through the personal library context, playlist manager, and Shellff-styled dashboard, all wired into authenticated playlist, likes, and listening-history API routes for persistence and sync hooks.【F:apps/web/contexts/PersonalLibraryContext.tsx†L4-L200】【F:apps/web/components/library/LibraryContent.tsx†L4-L200】【F:apps/web/components/library/PlaylistManager.tsx†L4-L200】【F:apps/web/app/api/playlists/route.ts†L8-L133】【F:apps/web/app/api/user/likes/route.ts†L7-L116】【F:apps/web/app/api/listen/history/route.ts†L9-L141】
- **Gaps:** Replace mock data with real catalog hydration, add cross-device sync/export persistence, and cover analytics-driven personalization so library stats, downloads, and recommendations stay accurate beyond a single session.
### Slice 6 — Wallet & Payments
- **Shipped:** The wallet provider and dashboard surface balances, transactions, payment methods, deposits, withdrawals, and voucher redemption through cohesive UI widgets and Prisma-backed REST endpoints that create wallets, initiate funding, and post ledger entries across fiat and crypto rails.【F:apps/web/contexts/WalletContext.tsx†L4-L200】【F:apps/web/components/wallet/WalletOverview.tsx†L4-L200】【F:apps/web/app/api/wallet/balances/route.ts†L9-L89】【F:apps/web/app/api/wallet/payment-methods/route.ts†L9-L99】【F:apps/web/app/api/wallet/deposit/route.ts†L16-L179】【F:apps/web/app/api/wallet/transactions/route.ts†L9-L121】【F:apps/web/app/api/wallet/withdraw/route.ts†L16-L142】【F:apps/web/app/api/wallet/voucher/redeem/route.ts†L14-L200】
- **Gaps:** Harden the finance flows with provider webhooks, reconciliation jobs, fraud/AML checks, and double-spend protections so ledger balances stay authoritative across retries and disputes.
### Slice 7 — Creator Upload & Royalty Engine
- **Shipped:** Upload workflows, royalty calculations, and contributor management remain unimplemented beyond general audit infrastructure.
- **Gaps:** Build upload wizard UX, media ingest pipeline, release metadata storage, royalty split enforcement, Stream-to-Earn toggles, and validations/tests for large file handling.
### Slice 8 — Admin Console
- **Shipped:** Aside from baseline feature-flag endpoints, no admin console UI or advanced admin APIs are present.
- **Gaps:** Create admin dashboards for feature flags, role management, moderation reports, audit exports, plus backend permissions, caching, and traceability tests.
### Slice 9 — Analytics
- **Shipped:** Analytics ingestion, aggregation, and dashboards have not begun; telemetry module only exposes basic health checks.
- **Gaps:** Implement event pipelines, storage schemas for analytics, dashboard UX, export endpoints, and analytics validation coverage.
### Slice 10 — Notifications & Realtime
- **Shipped:** There are no notification channels, websocket infrastructure, or push registration flows in place.
- **Gaps:** Deliver notification services, device token storage, websocket transport, PWA/native notification UX, and tests for delivery/permission handling.
### Slice 11 — DevOps, Moderation & Compliance
- **Shipped:** CI/CD hardening and Terraform scaffolding exist from Slice 0, but dedicated deployment dashboards, moderation tooling, and compliance automation are absent.
- **Gaps:** Build deploy dashboard, incident response tools, moderation/compliance APIs, GDPR/NDPR workflows, signed export mechanisms, and resilience test suites.
### Slice 12 — Mobile iOS App
- **Shipped:** Expo-managed React Native scaffold and tooling live in `apps/mobile`, including the baseline package scripts and the starter `App.tsx`, giving us an on-device shell to expand.【F:apps/mobile/package.json†L1-L73】【F:apps/mobile/src/App.tsx†L1-L52】
- **Gaps:** Layer the wallet, catalog, playback, and barcode experiences onto the scaffold, wire mobile auth, notifications, and offline sync to backend services, polish navigation/UX for iOS parity, and add native test coverage to validate feature completeness.
### Slice 13 — Mobile Android App
- **Shipped:** Android implementation has not started beyond monorepo planning; no native-specific code is committed.
- **Gaps:** Build Android React Native parity with wallet/catalog/playback/barcode features, notifications, offline support, and platform validation.
## 2. Remaining Scope
### Feature Flags & Audit Experience
- Expand flag APIs with richer telemetry/analytics hooks so downstream slices can observe rollout impacts; cached evaluations currently only emit audit logs for updates/overrides without surface-level metrics.【F:apps/api/src/feature-flags/feature-flags.service.ts†L64-L135】
### Telemetry & Monitoring
- Extend telemetry metrics beyond process uptime/memory to cover dependency health, Prisma query latency, and queue/worker readiness needed for later slices.【F:apps/api/src/telemetry/telemetry.service.ts†L10-L37】
- Emit structured failure telemetry when dependencies are unavailable to complement the health check exception path.【F:apps/api/src/telemetry/telemetry.service.ts†L10-L25】
### Tooling & Operations
- Mirror the CI wait-and-migrate flow in local onboarding scripts so contributors get automatic readiness checks before `db:seed`; existing scripts run migrations without confirming Postgres is reachable.【F:.github/workflows/ci.yml†L65-L78】【F:install/scripts/seed.sh†L1-L5】【F:install/scripts/seed.ps1†L1-L5】
- Document the new auth/feature-flag requirements (headers, environment variables) across install docs and package READMEs for frontend consumers.【F:apps/api/README.md†L6-L34】【F:install/.env.example†L1-L11】
### Testing & QA
- Add controller or e2e tests that exercise Prisma against a real database; existing unit specs mock Prisma and will not catch integration regressions introduced by migrations or DTO changes.【F:apps/api/src/auth/auth.service.spec.ts†L9-L99】【F:apps/api/src/roles/roles.service.spec.ts†L33-L113】【F:apps/api/src/feature-flags/feature-flags.service.spec.ts†L33-L122】
### “Unlock issues” Remediation Track
- Finish the pending migrations, seeds, and API updates for the physical unlock flow so barcode decoding, redemption persistence, and release access records align with the new schema guidance documented earlier in the audit.【F:where-we-are.txt†L81-L189】
- Add automated coverage (unit/integration/E2E) for redemption journeys once the domain changes land to keep regressions from reappearing.【F:where-we-are.txt†L93-L108】
## 3. Immediate Next Action
- Extend telemetry coverage to capture dependency readiness, Prisma latency, and worker health, and emit structured failure events so observability keeps pace with the new caching and audit flows before advancing other backlog items.【F:apps/api/src/telemetry/telemetry.service.ts†L1-L37】
